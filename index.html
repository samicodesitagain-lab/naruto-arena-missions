<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ninja Mission Helper</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“œ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-slate-900 text-slate-200 font-sans flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gradient-to-r from-slate-800 to-slate-900 border-b border-slate-700 p-3 md:p-4 shadow-lg z-10 flex items-center justify-between">
        <div class="flex items-center gap-2 md:gap-3">
            <i class="fa-solid fa-scroll text-emerald-400 text-xl md:text-2xl drop-shadow-lg"></i>
            <h1 class="text-base md:text-xl font-bold text-white tracking-wide">Ninja Mission <span
                    class="text-emerald-400 drop-shadow-lg">Helper</span></h1>
        </div>
        <!-- Mobile: Back button when detail is shown -->
        <button id="mobileBackBtn" class="md:hidden hidden bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg text-sm font-semibold transition-all duration-200">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden" style="min-height: 0;">

        <!-- Sidebar: Search & List -->
        <aside id="missionListPanel" class="w-full md:w-1/3 lg:w-1/4 bg-slate-800/50 border-r border-slate-700 flex flex-col" style="min-height: 0;">
            <div class="p-3 md:p-4 border-b border-slate-700">
                <div class="relative group">
                    <i class="fa-solid fa-search absolute left-3 top-3 md:top-3.5 text-slate-400 transition-colors group-focus-within:text-emerald-400"></i>
                    <input type="text" id="searchInput" placeholder="Find Character or Mission..."
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2.5 md:py-3 pl-10 pr-20 md:pr-16 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all shadow-inner placeholder-slate-500" style="font-size: 16px;">
                    <div class="absolute right-3 top-3 md:top-3.5 text-[10px] text-slate-600 hidden md:block border border-slate-700 px-1.5 rounded">Ctrl+K</div>
                </div>
                
                <!-- Category Filter -->
                <div class="relative mt-3">
                    <i class="fa-solid fa-filter absolute left-3 top-3 md:top-3.5 text-slate-400 pointer-events-none"></i>
                    <select id="categoryFilter" 
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2.5 md:py-3 pl-10 pr-3 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all shadow-inner text-slate-300 cursor-pointer" style="font-size: 16px;">
                        <option value="">All Categories</option>
                        <option value="D and C Rank Missions">D & C Rank</option>
                        <option value="B Rank Missions">B Rank</option>
                        <option value="A Rank Missions">A Rank</option>
                        <option value="S Rank Missions">S Rank</option>
                        <option value="Shippuuden Missions">Shippuuden</option>
                        <option value="Five Kage Summit Missions">Five Kage Summit</option>
                        <option value="Tales Missions">Tales</option>
                        <option value="Fourth Shinobi World War Pt. 1 Missions">World War Pt. 1</option>
                    </select>
                </div>
            </div>

            <div id="missionList" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Mission Items injected here -->
                <div class="text-center text-slate-500 mt-10 text-sm">Use search to find missions...</div>
            </div>
        </aside>

        <!-- Main Panel: Details & Tree -->
        <section id="detailPanel" class="flex-1 overflow-y-auto p-3 md:p-6 bg-slate-900 relative" style="display: none; min-height: 0;">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-500 opacity-50">
                <i class="fa-solid fa-dungeon text-6xl mb-4"></i>
                <p class="text-lg">Select a mission to analyze requirements</p>
            </div>

            <div id="contentState" class="hidden max-w-4xl mx-auto space-y-4 md:space-y-6">

                <!-- Mission Header Card -->
                <div class="bg-slate-800 rounded-lg md:rounded-xl p-4 md:p-6 border border-slate-700 shadow-xl relative overflow-hidden hover:shadow-2xl transition-shadow duration-300">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none">
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                        <div class="relative group">
                            <img id="missionImg" src="" alt="Mission"
                                class="w-20 h-20 md:w-24 md:h-24 rounded-lg object-cover border-2 border-slate-600 shadow-md bg-slate-700 transition-transform group-hover:scale-105">
                            <div class="absolute inset-0 rounded-lg bg-gradient-to-t from-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-2 gap-2">
                                <h2 id="missionName" class="text-lg md:text-2xl font-bold text-white leading-tight flex-1"></h2>
                                <span id="missionLevel"
                                    class="px-2.5 md:px-3 py-1 md:py-1.5 bg-gradient-to-r from-blue-900/70 to-blue-800/70 text-blue-200 text-xs font-bold rounded-lg border border-blue-700/50 whitespace-nowrap shadow-lg">LVL
                                    0</span>
                            </div>
                            <div class="text-xs md:text-sm text-slate-400 mb-3 md:mb-4 flex items-center gap-2" id="missionAnime">
                                <i class="fa-solid fa-tv text-emerald-400"></i>
                                <span></span>
                            </div>

                            <!-- Unlocks -->
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
                                <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Unlocks:
                                </div>
                                <div id="unlocksContainer" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Goals Section -->
                <div class="grid grid-cols-1 gap-4 md:gap-6">
                    <div class="bg-slate-800 rounded-lg md:rounded-xl p-4 md:p-5 border border-slate-700">
                        <h3 class="text-base md:text-lg font-bold text-white mb-3 md:mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-bullseye text-emerald-400"></i> Mission Goals
                        </h3>
                        <div id="goalsList" class="space-y-2 md:space-y-3"></div>
                    </div>
                </div>

                <!-- Prerequisite Tree -->
                <div class="bg-slate-800 rounded-lg md:rounded-xl p-4 md:p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-4 md:mb-6">
                        <h3 class="text-base md:text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-code-branch text-amber-400"></i> Prerequisite Path
                        </h3>
                        <div class="flex gap-2">
                            <button id="expandAllBtn" class="bg-slate-700 hover:bg-emerald-600 px-2.5 md:px-3 py-1.5 rounded text-xs font-semibold transition-all duration-200 hover:scale-105">
                                <i class="fa-solid fa-chevron-down mr-1"></i>Expand All
                            </button>
                            <button id="collapseAllBtn" class="bg-slate-700 hover:bg-slate-600 px-2.5 md:px-3 py-1.5 rounded text-xs font-semibold transition-all duration-200 hover:scale-105">
                                <i class="fa-solid fa-chevron-up mr-1"></i>Collapse
                            </button>
                        </div>
                    </div>
                    <div class="bg-slate-900/50 rounded-lg p-2 md:p-4 border border-slate-700/50 tree-container">
                        <div id="reqTree" class="space-y-0"></div>
                    </div>
                </div>

            </div>
        </section>
        
        <!-- Back to Top Button -->
        <button id="backToTop" class="fixed bottom-6 right-6 gradient-accent text-white w-12 h-12 rounded-full shadow-lg hover:shadow-xl hidden items-center justify-center transition-all duration-300 hover:scale-110 z-20">
            <i class="fa-solid fa-arrow-up"></i>
        </button>
    </main>

    <script src="characters.js"></script>
    <script src="missions.js"></script>
    <script>
        // --- STATE MANAGEMENT ---
        const missionMap = new Map();
        const charMap = new Map();
        const charUnlockMap = new Map();

        // Initialize Data
        if (typeof characterData !== 'undefined') {
            characterData.forEach(c => charMap.set(c.name, c.url));
        }
        rawData.forEach(m => {
            missionMap.set(m.name, m);
            if (m.unlockedCharacter) {
                charUnlockMap.set(m.unlockedCharacter, m.name);
            }
        });

        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('searchInput');
        const missionList = document.getElementById('missionList');
        const detailPanel = document.getElementById('detailPanel');
        const emptyState = document.getElementById('emptyState');
        const contentState = document.getElementById('contentState');
        const backToTopBtn = document.getElementById('backToTop');
        const expandAllBtn = document.getElementById('expandAllBtn');
        const collapseAllBtn = document.getElementById('collapseAllBtn');

        // --- VIEWPORT HEIGHT FIX ---
        const setAppHeight = () => {
            const viewport = window.visualViewport;
            const height = viewport ? viewport.height : window.innerHeight;
            document.documentElement.style.setProperty('--app-height', `${height}px`);
        };

        setAppHeight();
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('orientationchange', () => setTimeout(setAppHeight, 150));
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', setAppHeight);
            window.visualViewport.addEventListener('scroll', setAppHeight);
        }

        // --- LOGIC: RENDER LIST ---
        function renderList(filter = '', category = '') {
            const lowerFilter = filter.toLowerCase().trim();
            
            // Clear list immediately to prevent flash
            missionList.innerHTML = '';

            const filtered = rawData.filter(m => {
                // Filter by category
                if (category !== '' && m.anime !== category) return false;
                
                // Filter by search text
                if (lowerFilter === '') return true;
                return m.name.toLowerCase().includes(lowerFilter) ||
                    (m.unlockedCharacter && m.unlockedCharacter.toLowerCase().includes(lowerFilter));
            });

            if (filtered.length === 0) {
                missionList.innerHTML = '<div class="text-center text-slate-500 mt-4 text-sm"><i class="fa-solid fa-search mb-2 text-2xl block"></i>No missions found.</div>';
                return;
            }
            
            // Add result count for searches or filters
            if (lowerFilter !== '' || category !== '') {
                const countBadge = document.createElement('div');
                countBadge.className = 'px-3 py-2 text-xs text-slate-400 border-b border-slate-700 flex items-center justify-between';
                countBadge.innerHTML = `<span><i class="fa-solid fa-filter mr-1.5"></i>Filtered Results</span><span class="bg-emerald-900/30 text-emerald-400 px-2 py-0.5 rounded-full font-semibold">${filtered.length}</span>`;
                missionList.appendChild(countBadge);
            }
            
            filtered.forEach(m => {
                const item = document.createElement('div');
                item.className = 'bg-slate-800 p-3 rounded-lg border border-slate-700 hover:border-emerald-500 cursor-pointer transition-all duration-200 hover:scale-[1.02] group';
                item.onclick = () => selectMission(m.name);
                
                let charBadge = '';
                if (m.unlockedCharacter) {
                    charBadge = `<div class="text-xs text-emerald-400 font-semibold mt-1"><i class="fa-solid fa-unlock-keyhole mr-1"></i> ${m.unlockedCharacter}</div>`;
                }

                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${m.url}" class="w-10 h-10 rounded object-cover bg-slate-700 transition-transform group-hover:scale-110" onerror="this.src='https://via.placeholder.com/40'">
                        <div>
                            <div class="text-sm font-bold text-slate-200 group-hover:text-white transition-colors">${m.name}</div>
                            ${charBadge}
                        </div>
                    </div>
                `;
                
                missionList.appendChild(item);
            });
        }

        // --- TREE CONTROLS ---
        function expandAllTree() {
            // First, trigger loading of all lazy-loaded children
            const allToggles = document.querySelectorAll('.tree-toggle:not(.invisible)');
            allToggles.forEach(toggle => {
                const onclick = toggle.onclick;
                if (onclick && toggle.classList.contains('collapsed')) {
                    // Trigger the onclick to load children
                    const fakeEvent = { stopPropagation: () => {} };
                    onclick.call(toggle, fakeEvent);
                }
            });
            
            // Then expand all
            setTimeout(() => {
                document.querySelectorAll('.tree-children').forEach(el => {
                    el.classList.remove('hidden');
                });
                document.querySelectorAll('.tree-toggle').forEach(el => {
                    el.classList.remove('collapsed');
                });
            }, 50);
        }

        function collapseAllTree() {
            const treeRoot = document.getElementById('reqTree');
            // Keep only the first level expanded
            treeRoot.querySelectorAll('.tree-children').forEach(el => {
                el.classList.add('hidden');
            });
            treeRoot.querySelectorAll('.tree-toggle').forEach(el => {
                el.classList.add('collapsed');
            });
        }

        // --- BACK TO TOP ---
        detailPanel.addEventListener('scroll', () => {
            if (detailPanel.scrollTop > 300) {
                backToTopBtn.classList.remove('hidden');
                backToTopBtn.classList.add('flex');
            } else {
                backToTopBtn.classList.add('hidden');
                backToTopBtn.classList.remove('flex');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            detailPanel.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // --- MOBILE NAVIGATION ---
        let isMobile = window.innerWidth < 768;
        window.addEventListener('resize', () => {
            isMobile = window.innerWidth < 768;
        });

        const mobileBackBtn = document.getElementById('mobileBackBtn');
        const missionListPanel = document.getElementById('missionListPanel');

        function showMissionList() {
            if (isMobile) {
                missionListPanel.style.display = 'flex';
                detailPanel.style.display = 'none';
                mobileBackBtn.classList.add('hidden');
                missionListPanel.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showMissionDetail() {
            if (isMobile) {
                missionListPanel.style.display = 'none';
                detailPanel.style.display = 'block';
                mobileBackBtn.classList.remove('hidden');
                detailPanel.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                detailPanel.style.display = 'block';
            }
        }

        mobileBackBtn.addEventListener('click', showMissionList);

        // --- LOGIC: DETAILS VIEW ---
        function selectMission(name) {
            const m = missionMap.get(name);
            if (!m) return;

            // Toggle Panels
            emptyState.classList.add('hidden');
            contentState.classList.remove('hidden');

            // Show detail panel on mobile
            showMissionDetail();
            
            // Scroll to top smoothly
            if (!isMobile) {
                detailPanel.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Header Data
            document.getElementById('missionName').innerText = m.name;
            document.getElementById('missionImg').src = m.url;
            document.getElementById('missionLevel').innerText = `Level ${m.levelRequirement}`;
            document.getElementById('missionAnime').querySelector('span').innerText = m.anime;


            // Unlocks
            const unlocksContainer = document.getElementById('unlocksContainer');
            unlocksContainer.innerHTML = '';
            if (m.unlockedCharacter) {
                const charUrl = charMap.get(m.unlockedCharacter);
                let imgHtml = '';
                if (charUrl) {
                    imgHtml = `<img src="${charUrl}" class="w-5 h-5 rounded-full border border-emerald-500/50 mr-2 object-cover shadow-sm">`;  
                }
                unlocksContainer.innerHTML += `<span class="bg-gradient-to-r from-emerald-900/50 to-emerald-800/50 text-emerald-300 px-3 py-1.5 rounded-lg text-sm border border-emerald-700/50 flex items-center shadow-lg hover:shadow-emerald-500/20 transition-shadow">${imgHtml}${m.unlockedCharacter}</span>`;
            } else if (m.unlockedBorder) {
                unlocksContainer.innerHTML += `<span class="bg-gradient-to-r from-purple-900/50 to-purple-800/50 text-purple-300 px-3 py-1.5 rounded-lg text-sm border border-purple-700/50 shadow-lg"><i class="fa-solid fa-border-all mr-2"></i>Border: ${m.unlockedBorder}</span>`;
            } else {
                unlocksContainer.innerHTML += `<span class="text-slate-500 text-sm italic flex items-center"><i class="fa-solid fa-arrow-right mr-2 text-slate-600"></i>Next Mission Progression</span>`;
            }

            // Goals Logic & Strategy
            const goalsList = document.getElementById('goalsList');
            goalsList.innerHTML = '';

            m.missionGoals.forEach(g => {
                const el = document.createElement('div');
                el.className = 'bg-slate-900 p-2.5 md:p-3 rounded border border-slate-700 text-xs md:text-sm flex items-start gap-2 md:gap-3 hover:border-slate-600 transition-all duration-200 hover:shadow-md';

                let icon = 'fa-trophy';
                let color = 'text-yellow-500';

                if (g.type === 'useSkill') {
                    icon = 'fa-bolt';
                    color = 'text-blue-400';
                }

                // Text generation
                let desc = g.text;
                if (!desc) {
                    if (g.type === 'win') {
                        let subjects = g.with;
                        if (Array.isArray(g.with)) {
                            if (g.sameTeam) {
                                subjects = g.with.join(' and ');
                            } else {
                                subjects = g.with.join(' or ');
                            }
                        }

                        desc = `Win ${g.value} battles with ${subjects}`;
                        if (g.sameTeam) {
                            desc += " on the same team";
                        }
                    }
                }

                // Logic for Streaks
                if (g.isrow) {
                    // Highlight or append "in a row"
                    if (desc.toLowerCase().includes('in a row')) {
                        desc = desc.replace(/in a row/yi, '<span class="text-red-400 font-bold">in a row</span>');
                    } else {
                        desc += ' <span class="text-red-400 font-bold">in a row</span>';
                    }
                }

                // Avatar Logic
                let avatarHtml = '';
                if (g.with) {
                    const names = Array.isArray(g.with) ? g.with : [g.with];
                    const avatars = names.map(name => {
                        const url = charMap.get(name);
                        if (url) {
                            return `<img src="${url}" title="${name}" class="w-6 h-6 rounded-full border border-slate-600 bg-slate-800 object-cover">`;
                        }
                        return '';
                    }).join('');

                    if (avatars) {
                        avatarHtml = `<span class="inline-flex gap-1 mr-2 align-middle">${avatars}</span>`;
                    }
                }

                el.innerHTML = `
                    <div class="mt-0.5 ${color}"><i class="fa-solid ${icon}"></i></div>
                    <div class="text-slate-200">
                        ${avatarHtml}${desc}
                    </div>
                `;
                goalsList.appendChild(el);
            });

            // Tree Construction
            const treeContainer = document.getElementById('reqTree');
            treeContainer.innerHTML = '';
            buildTree(m.name, treeContainer);
        }

        // --- LOGIC: RECURSIVE TREE ---
        function buildTree(missionName, container) {
            // Clear container first if it's the root call
            if (container.id === 'reqTree') {
                container.innerHTML = '';
                container.className = 'tree-root'; // Add root class for CSS
            }

            const m = missionMap.get(missionName);
            if (!m) return;

            createTreeNode(m, container, new Set(), true);
        }

        function getImplicitRequirements(mission) {
            const implicitReqs = new Map(); // MissionName -> CharacterName
            if (!mission.missionGoals) return implicitReqs;

            mission.missionGoals.forEach(goal => {
                if (goal.with) {
                    const characters = Array.isArray(goal.with) ? goal.with : [goal.with];
                    characters.forEach(charName => {
                        const unlockMissionName = charUnlockMap.get(charName);
                        // Avoid self-reference if the mission requires the character it unlocks (unlikely but possible)
                        if (unlockMissionName && unlockMissionName !== mission.name) {
                            if (!implicitReqs.has(unlockMissionName)) {
                                implicitReqs.set(unlockMissionName, charName);
                            }
                        }
                    });
                }
            });
            return implicitReqs;
        }

        function createTreeNode(mission, parentElement, visited = new Set(), isExpanded = false, reason = null) {
            // Cycle detection
            if (visited.has(mission.name)) {
                const errorNode = document.createElement('div');
                errorNode.className = 'text-red-500 text-xs p-2';
                errorNode.innerText = `Cycle detected: ${mission.name}`;
                parentElement.appendChild(errorNode);
                return;
            }

            const newVisited = new Set(visited);
            newVisited.add(mission.name);

            const explicitReqs = mission.completedRequeriments || [];
            const implicitReqsMap = getImplicitRequirements(mission);

            // Combine and deduplicate
            const allReqs = new Set(explicitReqs);
            for (const req of implicitReqsMap.keys()) {
                allReqs.add(req);
            }
            const hasChildren = allReqs.size > 0;

            // 1. Create Item Container
            const item = document.createElement('div');
            item.className = 'tree-item';

            // 2. Create Content Row
            const content = document.createElement('div');
            content.className = 'tree-content';

            // Toggle Button
            const toggle = document.createElement('div');
            toggle.className = `tree-toggle ${hasChildren ? '' : 'invisible'} ${isExpanded ? '' : 'collapsed'}`;
            toggle.innerHTML = '<i class="fa-solid fa-chevron-down"></i>';

            // Mission Card
            const card = document.createElement('div');
            card.className = 'mission-node';
            card.onclick = (e) => {
                // Prevent toggling when clicking the card itself
                e.stopPropagation();
                selectMission(mission.name);
            };

            // Highlight if it's the currently viewed mission (optional logic, can be added later)
            if (document.getElementById('missionName').innerText === mission.name) {
                card.classList.add('active');
            }

            let metaContent = `<span class="text-emerald-500 font-bold">Lvl ${mission.levelRequirement}</span>`;
            let extraContent = '';

            if (reason) {
                // Implicit requirement: Highlight the unlock as the reason
                extraContent = `<div class="text-xs text-amber-400 mt-1 font-semibold"><i class="fa-solid fa-key mr-1"></i>Unlocks required character: ${reason}</div>`;
            } else {
                // Standard requirement
                if (mission.unlockedCharacter) {
                    metaContent += `<span> â€¢ Unlock: ${mission.unlockedCharacter}</span>`;
                }
            }

            card.innerHTML = `
                <img src="${mission.url}" onerror="this.src='https://via.placeholder.com/32'">
                <div class="mission-node-info">
                    <div class="mission-node-title">${mission.name}</div>
                    <div class="mission-node-meta">
                        ${metaContent}
                    </div>
                    ${extraContent}
                </div>
            `;

            content.appendChild(toggle);
            content.appendChild(card);
            item.appendChild(content);

            // 3. Create Children Container
            if (hasChildren) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = `tree-children ${isExpanded ? '' : 'hidden'}`;

                let childrenLoaded = false;

                const loadChildren = () => {
                    if (!childrenLoaded) {
                        allReqs.forEach(reqName => {
                            const reqMission = missionMap.get(reqName);
                            if (reqMission) {
                                // Determine reason
                                let childReason = null;
                                // If it is NOT in explicit reqs, but IS in implicit reqs, pass the reason
                                if (!explicitReqs.includes(reqName) && implicitReqsMap.has(reqName)) {
                                    childReason = implicitReqsMap.get(reqName);
                                }

                                createTreeNode(reqMission, childrenContainer, newVisited, false, childReason);
                            }
                        });
                        childrenLoaded = true;
                    }
                };

                if (isExpanded) {
                    loadChildren();
                }

                // Toggle Logic
                toggle.onclick = (e) => {
                    e.stopPropagation();
                    loadChildren();
                    const wasHidden = childrenContainer.classList.contains('hidden');
                    childrenContainer.classList.toggle('hidden');
                    toggle.classList.toggle('collapsed');
                    
                    // Scroll into view on mobile when expanding
                    if (wasHidden && window.innerWidth < 768) {
                        setTimeout(() => {
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                };

                item.appendChild(childrenContainer);
            }

            parentElement.appendChild(item);
        }

        // --- EVENT LISTENERS ---
        const categoryFilter = document.getElementById('categoryFilter');
        let searchTimeout;
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderList(e.target.value, categoryFilter.value);
            }, 200);
        });
        
        categoryFilter.addEventListener('change', (e) => {
            renderList(searchInput.value, e.target.value);
        });
        
        // Keyboard shortcut: Ctrl+K to focus search
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
        });
        
        expandAllBtn.addEventListener('click', expandAllTree);
        collapseAllBtn.addEventListener('click', collapseAllTree);
        
        // --- INIT ---
        // Set initial panel visibility for mobile
        if (window.innerWidth < 768) {
            missionListPanel.style.display = 'flex';
            detailPanel.style.display = 'none';
        } else {
            missionListPanel.style.display = 'flex';
            detailPanel.style.display = 'block';
        }
        
        renderList();

    </script>
</body>

</html>